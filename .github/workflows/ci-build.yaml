name : ci Build

on: 
  push:
    branches: 
      - main
  pull_request:
    branches: 
      - main

jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Set up Python
        uses: actions/setup-python@v6.0.0
        with:
          python-version: '3.10'

      - name: Cache pip
        uses: actions/cache@v4.3.0
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements-docker.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip wheel
          pip install -r requirements-docker.txt

      - name: Run Ruff-linter
        run: |
          pip install ruff
          # newer ruff versions use subcommands; call `ruff check` explicitly
          ruff check .

      - name: Run tests with pytest (with coverage)
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          PYTHONPATH: ${{ github.workspace }}
        run: |
          python -m pip install pytest-cov
          # produce coverage.xml for SonarQube/SonarCloud
          python -m pytest -q -v -r a --maxfail=1 --showlocals --color=yes --cov=src --cov-branch --cov-report=term-missing:skip-covered --cov-report=xml:coverage.xml --ignore=kokoro

      - name: Run manual SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@fd88b7d7ccbaefd23d8f36f73b59db7a3d246602 # v6.0.0
        with:
          args: 
            -Dsonar.projectKey=RobHaRepos_TTS_kokoro -Dsonar.organization=${{ secrets.SONAR_ORGANIZATION }} -Dsonar.token=${{ secrets.SONAR_TOKEN }}
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: Install Snyk CLI
        run: |
          curl https://downloads.snyk.io/cli/stable/snyk-linux -o snyk-linux
          curl https://downloads.snyk.io/cli/stable/snyk-linux.sha256 -o snyk.sha256
          sha256sum -c snyk.sha256
          chmod +x snyk-linux
          sudo mv snyk-linux /usr/local/bin/snyk
      - name: Run Snyk to test project dependencies
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          # Run Snyk against the CI requirements (omits heavy runtime ML deps like torch)
          # explicitly tell Snyk this is a pip/requirements file so it detects the package manager
          snyk test --file=requirements-ci.txt --package-manager=pip